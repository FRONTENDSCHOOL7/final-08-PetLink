<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=\, initial-scale=1.0">
  <title>회원가입</title>
</head>

<body>
  <div id="root">
    <section class="email-pw">
      <h2 class="main-title">이메일로 회원가입</h2>
      <div class="input-container">
        <label for="emailInput">이메일</label>
        <input type="email" id="emailInput" data-state="0" placeholder="이메일 주소를 알려주세요.">
      </div>
      <div class="input-container input-container-pw">
        <label for="passwordInput">비밀번호</label>
        <input type="password" id="passwordInput" data-state="0" placeholder="비밀번호를 설정해 주세요.">
      </div>
      <button type="button" class="next-btn">다음</button>
    </section>

    <section class="profile" style="display:none">
      <h2 class="main-title join-profile-title">프로필 설정</h2>
      <p class="profile-info-txt">나중에 언제든지 변경할 수 있습니다.</p>
      <label for="profileImg">
        <img src="https://api.mandarin.weniv.co.kr/Ellipse.png" alt="" srcset="" id="imagePre">
      </label>
      <input type="file" id="profileImg" name="profile-img" accept="image/*" class="ir" />
      <div class="input-container">
        <label for="userNameInput">사용자 이름</label>
        <input type="text" id="userNameInput" data-state="0" placeholder="2~10자 이내여야 합니다.">
      </div>
      <div class="input-container">
        <label for="userIdInput">계정 ID</label>
        <input type="text" id="userIdInput" data-state="0" placeholder="영문, 숫자, 특수문자(,), (_)만 사용 가능합니다.">
      </div>
      <div class="input-container input-container-intro">
        <label for="userIntroInput">소개</label>
        <input type="text" id="userIntroInput" data-state="1" placeholder="자신과 판매할 상품에 대해 소개해 주세요.">
      </div>
      <button type="button" class="submit-btn">감귤마켓 시작하기</button>
    </section>
  </div>
</body>

<script>
  const $emailPwForm = document.querySelector("#root > section.email-pw");
  const $profileForm = document.querySelector("#root > section.profile");

  let userEmail = ""; // userEmail을 저장할 전역 변수

  async function checkEmailValid(email) {
    const url = "https://api.mandarin.weniv.co.kr";
    const emailValidReqPath = "/user/emailvalid";
    const reqData = {
      "user": {
        "email": email
      }
    };

    try {
      const res = await fetch(url + emailValidReqPath, {
        method: "POST",
        headers: {
          "Content-type": "application/json"
        },
        body: JSON.stringify(reqData)
      });

      const json = await res.json();
      const reqMsg = json.message;

      if (reqMsg === "이미 가입된 이메일 주소 입니다.") {
        alert("이미 가입된 이메일 주소입니다.");
        return false;
      } else {
        userEmail = email; // userEmail 변수 업데이트
        return true;
      }
    } catch (error) {
      console.error(error);
      alert("이메일 유효성 검사 중 오류가 발생했습니다.");
      return false;
    }
  }

  async function submitProfile() {
    const userName = document.querySelector("#userNameInput").value;
    const userId = document.querySelector("#userIdInput").value;
    const intro = document.querySelector("#userIntroInput").value;
    const imageUrl = document.querySelector("#imagePre").src;

    const profileData = {
      "user": {
        "username": userName,
        "email": userEmail, // userEmail 전역 변수 사용
        "accountname": userId,
        "intro": intro,
        "image": imageUrl
      }
    };

    try {
      const response = await fetch("https://api.mandarin.weniv.co.kr/user", {
        method: "POST",
        headers: {
          "Content-type": "application/json"
        },
        body: JSON.stringify(profileData)
      });

      const data = await response.json();
      console.log(data);

      if (response.status === 200) {
        alert("프로필이 성공적으로 제출되었습니다.");
      } else {
        alert("프로필 제출 중 오류가 발생했습니다: " + data.message);
      }
    } catch (error) {
      console.error(error);
      alert("프로필 제출 중 오류가 발생했습니다.");
    }
  }

  // 이벤트 리스너를 "감귤마켓 시작하기" 버튼에 추가
  const $submitProfileButton = document.querySelector("#root > section.profile > button");
  $submitProfileButton.addEventListener("click", submitProfile);

  function checkPasswordValid(password) {
    //password가 6글자 이상인경우에 true반환
    return true
  }
  const getEmailPw = () => {
    const email = document.querySelector("#emailInput").value;
    const pw = document.querySelector("#passwordInput").value;
    return [email, pw]
  }
  async function checkValid() {
    const [email, pw] = getEmailPw()
    console.log(email)
    const emailCheckedResult = await checkEmailValid(email);
    const passwordCheckedResult = await checkPasswordValid(pw);

    if (emailCheckedResult && passwordCheckedResult) {
      $emailPwForm.style.display = "none";
      $profileForm.style.display = "block";
    }
  }
  const $nextButton = document.querySelector("#root > section.email-pw > button");
  $nextButton.addEventListener("click", checkValid)

  const url = "https://api.mandarin.weniv.co.kr";

  // 이미지 업로드해서 url받아오기
  async function imageUpload(file) {
    const url = "https://api.mandarin.weniv.co.kr";
    const formData = new FormData();
    formData.append("image", file);

    try {
      const response = await fetch(url + "/image/uploadfile", {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      if (data.filename) {
        return url + "/" + data.filename;
      } else {
        console.error("Image upload failed:", data);
        return null;
      }
    } catch (err) {
      console.error(err);
      return null;
    }
  }

  async function handleGetImageUrl(e) {
    console.log(e.target.files)
    const file = e.target.files[0]
    const imgSrc = await imageUpload(file)
    document.querySelector("#imagePre").src = imgSrc

  }
  const $profileImageInput = document.querySelector("#profileImg");
  $profileImageInput.addEventListener("change", handleGetImageUrl)

  //계정중복검사
  async function checkAccountnameValid(userId) {
    console.log(userId)
    if (userId == "") {
      return false
    }
    const reqData = {
      "user": {
        "accountname": "werewrewrwrew"
      }
    }
    console.log(url + "/user/accountnamevalid");
    const res = await fetch(url + "/user/accountnamevalid", {
      method: "POST",
      headers: {
        "Content-type": "application/json"
      },
      body: JSON.stringify(reqData)
    })
    const json = await res.json()
    if (json.message == '사용 가능한 계정ID 입니다.') {
      return true
    }
    return false
  }
  //회원가입
  async function join() {
    const email = document.querySelector("#emailInput").value;
    const password = document.querySelector("#passwordInput").value;
    const userName = document.querySelector("#userNameInput").value;
    const userId = document.querySelector("#userIdInput").value;
    const intro = document.querySelector("#userIntroInput").value;
    const imageUrl = document.querySelector("#imagePre").src;
    const checkedIdResult = await checkAccountnameValid(userId);

    if (checkedIdResult) {
      const joinData = {
        "user": {
          "username": userName,
          "email": email,
          "password": password,
          "accountname": userId,
          "intro": intro,
          "image": imageUrl // 이 부분은 이미지의 전체 URL이어야 합니다.
        }
      };

      try {
        const response = await fetch(url + "/user", {
          method: "POST",
          headers: {
            "Content-type": "application/json"
          },
          body: JSON.stringify(joinData)
        });

        const data = await response.json();
        console.log(data);
      } catch (err) {
        console.error(err);
      }
    }
  }

  const $joinButton = document.querySelector("#root > section.profile > button");
  $joinButton.addEventListener("click", join);
</script>

</html>

</html>